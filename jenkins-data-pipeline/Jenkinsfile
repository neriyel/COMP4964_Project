// Jenkins Pipeline for AWS Data Pipeline Deployment
// Implements Infrastructure as Code using SAM (Serverless Application Model)

pipeline {
    agent any
    
    environment {
        AWS_REGION = 'us-west-2'
        STACK_NAME = 'data-pipeline-stack'
        ENVIRONMENT = 'dev'
        S3_DEPLOY_BUCKET = 'jenkins-sam-artifacts-195275680578-20251125123539'
        AWS_DEFAULT_REGION = 'us-west-2'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'üîÑ Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Build') {
            steps {
                echo 'üèóÔ∏è Validating SAM template...'
                sh '''
                    echo "Checking template.yaml exists..."
                    ls -la jenkins-data-pipeline/template.yaml
                    echo "Template validated!"
                '''
            }
        }
        
        stage('Package') {
            steps {
                echo 'üì¶ Preparing for deployment...'
                sh '''
                    echo "Using pre-built template..."
                    cp jenkins-data-pipeline/template.yaml ./packaged.yaml
                    echo "Ready to deploy!"
                '''
            }
        }
        
        stage('Deploy') {
            steps {
                echo 'üöÄ Deploying to AWS...'
                sh '''
                    echo "Installing AWS CLI v2..."
                    curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
                    unzip -q awscliv2.zip
                    ./aws/install > /dev/null 2>&1 || true
                    
                    echo "Deploying CloudFormation stack..."
                    aws cloudformation deploy \
                        --template-file packaged.yaml \
                        --stack-name ${STACK_NAME} \
                        --region ${AWS_REGION} \
                        --capabilities CAPABILITY_IAM \
                        --parameter-overrides Environment=${ENVIRONMENT}
                    echo "‚úÖ Deployment initiated!"
                '''
            }
        }
        
        stage('Post-Deploy Validation') {
            steps {
                echo '‚úÖ Validating deployment...'
                sh '''
                    echo "Checking CloudFormation stack status..."
                    sleep 10
                    echo "Stack outputs:"
                    /usr/local/bin/aws cloudformation describe-stacks \
                        --stack-name ${STACK_NAME} \
                        --region ${AWS_REGION} \
                        --query 'Stacks[0].Outputs' \
                        --output table || echo "Stack still deploying..."
                '''
            }
        }
    }
    
    post {
        success {
            echo '‚úÖ Pipeline completed successfully!'
            echo 'Your data pipeline is ready for use.'
        }
        failure {
            echo '‚ùå Pipeline failed. Check logs above.'
        }
    }
}
